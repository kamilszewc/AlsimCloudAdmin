<h5>User {{user?.id}} {{user?.username}} ({{user?.email}})</h5>

<form class="row g-3 was-validated" #userForm="ngForm">
  <div class="col-md-6">
    <label for="firstName" class="form-label">First name</label>
    <input type="text" class="form-control" id="firstName" name="firstName" [(ngModel)]="user!.firstName" [value]="user?.firstName" [disabled]="!isEditAllowed">
  </div>
  <div class="col-md-6">
    <label for="secondName" class="form-label">Second name</label>
    <input type="text" class="form-control" id="secondName" name="secondName" [(ngModel)]="user!.secondName" [value]="user?.secondName" [disabled]="!isEditAllowed">
  </div>

  <div class="col-12">
    <label for="inputAddress" class="form-label">Address</label>
    <input type="text" class="form-control" id="inputAddress" name="street" [(ngModel)]="user!.street" [value]="user?.street" [disabled]="!isEditAllowed">
  </div>

  <div class="col-md-6">
    <label for="city" class="form-label">City</label>
    <input type="text" class="form-control" id="city" name="city" [(ngModel)]="user!.city" [value]="user?.city" [disabled]="!isEditAllowed">
  </div>
  <div class="col-md-4">
    <label for="country" class="form-label">Country</label>
    <select id="country" class="form-select" [disabled]="!isEditAllowed" [(ngModel)]="user!.country" name="country">
      <option *ngFor="let country of countries?.keys()" [value]="country">{{countries?.get(country)}}</option>
    </select>
  </div>
  <div class="col-md-2">
    <label for="postCode" class="form-label">Post code</label>
    <input type="text" class="form-control" id="postCode" name="postCode" [(ngModel)]="user!.postCode" [value]="user?.postCode" [disabled]="!isEditAllowed">
  </div>

  <div class="col-md-6">
    <label for="companyName" class="form-label">Company name</label>
    <input type="text" class="form-control" id="companyName" name="companyName" [(ngModel)]="user!.companyName" [value]="user?.companyName" [disabled]="!isEditAllowed">
  </div>
  <div class="col-md-6">
    <label for="taxId" class="form-label">Tax id</label>
    <input type="text" class="form-control" id="taxId" name="taxId" [(ngModel)]="user!.taxId" [value]="user?.taxId" [disabled]="!isEditAllowed">
  </div>

  <div class="col-md-2">
    <label for="maxNumberOfRunningTasks" class="form-label">Max no of running tasks</label>
    <input type="number" min="0" class="form-control" id="maxNumberOfRunningTasks" name="maxNumberOfRunningTasks" [(ngModel)]="user!.maxNumberOfRunningTasks" [value]="user?.maxNumberOfRunningTasks" disabled>
  </div>
  <div class="col-md-2">
    <label for="priority" class="form-label">User priority</label>
    <input type="number" min="0" max="20" class="form-control" id="priority" name="priority" [(ngModel)]="user!.priority" [value]="user?.priority" [disabled]="!isEditAllowed">
    <div class="invalid-feedback">The value must be between 0 and 20</div>
  </div>
  <div class="col-md-2">
    <label for="effectivePriority" class="form-label">Effective priority</label>
    <input type="number" min="0" max="20" class="form-control" id="effectivePriority" name="effectivePriority" [(ngModel)]="user!.effectivePriority" [value]="user?.effectivePriority" disabled>
  </div>
  <div class="col-md-3">
    <label for="userType" class="form-label">User type</label>
    <select id="userType" class="form-select" [value]="user?.userType" name="userType" [(ngModel)]="user!.userType" [disabled]="!isEditAllowed">
      <option *ngFor="let userType of userTypes" [value]="userType" [selected]="userType === user?.userType">{{userType}}</option>
    </select>
  </div>
  <div class="col-md-3">
    <label for="consumerGroup" class="form-label">Group</label>
    <select id="consumerGroup" class="form-select" [value]="user?.consumerGroup" name="consumerGroup" [(ngModel)]="user!.consumerGroup" [disabled]="!isEditAllowed">
      <option [value]="" [selected]="null === user?.consumerGroup">no group</option>
      <option *ngFor="let group of groups" [value]="group" [selected]="group === user?.consumerGroup">{{group}}</option>
    </select>
  </div>

  <div class="col-md-2">
    <div class="form-check">
      <input class="form-check-input" type="checkbox" id="isEss" name="isEss" [(ngModel)]="user!.isEss" [checked]="user?.isEss" disabled>
      <label class="form-check-label" for="isEss">
        Is ESS
      </label>
    </div>
  </div>
  <div class="col-md-2">
    <div class="form-check">
      <input class="form-check-input" type="checkbox" id="isAdmin" name="isAdmin" [(ngModel)]="user!.isAdmin" [checked]="user?.isAdmin" [disabled]="!isEditAllowed">
      <label class="form-check-label" for="isAdmin">
        Is admin
      </label>
    </div>
  </div>
  <div class="col-md-2">
    <div class="form-check">
      <input class="form-check-input" type="checkbox" id="isEducational" name="isEducational" [(ngModel)]="user!.isEducational" [checked]="user?.isEducational" [disabled]="!isEditAllowed">
      <label class="form-check-label" for="isEducational">
        Is educational
      </label>
    </div>
  </div>
  <div class="col-md-2">
    <div class="form-check">
      <input class="form-check-input" type="checkbox" id="isAlsim" [checked]="user?.loggedFromAlsimCloud" disabled="true">
      <label class="form-check-label" for="isAlsim">
        Logged as alsim cloud
      </label>
    </div>
  </div>
  <div class="col-md-2">
    <div class="form-check">
      <input class="form-check-input" type="checkbox" id="isDynairix" [checked]="user?.loggedFromDynairix" disabled="true">
      <label class="form-check-label" for="isDynairix">
        Logged as Dynairix
      </label>
    </div>
  </div>
  <div class="col-md-2">
    <div class="form-check">
      <input class="form-check-input" type="checkbox" id="isUsing2FA" [checked]="user?.using2FA" disabled="true">
      <label class="form-check-label" for="isUsing2FA">
        Is using 2FA
      </label>
    </div>
  </div>

  <div class="col-12" *ngIf="isEditAllowed == false">
    <button type="submit" class="btn btn-primary" (click)="allowEdit()">Edit</button>
  </div>
  <div class="col-12" *ngIf="isEditAllowed == true">
    <button type="submit" class="btn btn-warning" (click)="editUser()">Submit</button>&nbsp;
    <button type="submit" class="btn btn-primary" (click)="reload()">Cancel</button>
  </div>
</form>

<br/>

<h5>eCubes balance</h5>

<form class="row g-3" #userTokensRechargeForm="ngForm">
  <div class="col-md-4">
    <label for="tokenBalance" class="form-label">Current eCubes balance</label>
    <input type="string" class="form-control" id="tokenBalance"  value="{{user?.tokenBalance}}" disabled>
  </div>
  <div class="col-md-4">
    <label for="tokensToBeAddedRemoved" class="form-label">eCubes to add/remove</label>
    <input type="number" min="0" class="form-control" id="tokensToBeAddedRemoved" name="tokensToBeAddedRemoved" ngModel>
  </div>
  <div class="col-md-2">
    <label class="form-label">&nbsp;</label>
    <button type="submit" class="btn btn-primary form-control" (click)="giveUserTokens()">Give</button>
  </div>
  <div class="col-md-2">
    <label class="form-label">&nbsp;</label>
    <button type="submit" class="btn btn-primary form-control" (click)="takeUserTokens()">Take</button>
  </div>
</form>

<form class="row g-3" #groupTokensRechargeForm="ngForm">
  <div class="col-md-4">
    <label for="groupTokenBalance" class="form-label">Current group token balance</label>
    <input type="string" class="form-control" id="groupTokenBalance" value="{{user?.groupTokenBalance}}" disabled="true">
  </div>
  <div class="col-md-4">
    <label for="groupTokensToBeAddedRemoved" class="form-label">eCubes to add/remove</label>
    <input type="number" min="0" class="form-control" id="groupTokensToBeAddedRemoved" name="tokensToBeAddedRemoved" ngModel [disabled]="user?.consumerGroup == null">
  </div>
  <div class="col-md-2">
    <label class="form-label">&nbsp;</label>
    <button type="submit" class="btn btn-primary form-control" (click)="giveGroupTokens()" [disabled]="user?.consumerGroup == null">Give</button>
  </div>
  <div class="col-md-2">
    <label class="form-label">&nbsp;</label>
    <button type="submit" class="btn btn-primary form-control" (click)="takeGroupTokens()" [disabled]="user?.consumerGroup == null">Take</button>
  </div>
</form>

<br/>

<!-- List of user tasks -->
<h5>List of tasks</h5>
<div class="mat-elevation-z8">
  <table mat-table #userTasksTable [dataSource]="userTasks" matSort matSortActive="id" matSortDisableClear matSortDirection="asc">

    <!-- Id Column -->
    <ng-container matColumnDef="id">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Id </th>
      <td mat-cell *matCellDef="let element"> {{element.id}} </td>
    </ng-container>

    <!-- Name Column -->
    <ng-container matColumnDef="name">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Name </th>
      <td mat-cell *matCellDef="let element"> {{element.name}} </td>
    </ng-container>

    <!-- Status Column -->
    <ng-container matColumnDef="status">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Status </th>
      <td mat-cell *matCellDef="let element"> {{element.status}} </td>
    </ng-container>

    <!-- Progress Column -->
    <ng-container matColumnDef="progress">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Progress </th>
      <td mat-cell *matCellDef="let element"> {{element.progress}} </td>
    </ng-container>

    <!-- Schema Column -->
    <ng-container matColumnDef="schema">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Schema </th>
      <td mat-cell *matCellDef="let element"> <a [routerLink]="'/schema/' + element.schema.id">{{element.schema.name}}</a> </td>
    </ng-container>

    <!-- Resource Column -->
    <ng-container matColumnDef="resource">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Resource </th>
      <td mat-cell *matCellDef="let element"> <a [routerLink]="'/resource/' + element.resource?.id" >{{element.resource?.name}}</a> </td>
    </ng-container>

    <!-- Files Column -->
    <ng-container matColumnDef="files">
      <th mat-header-cell *matHeaderCellDef mat-sort-header></th>
      <td mat-cell *matCellDef="let element">
        <button type="button" class="btn btn-primary btn-sm" (click)="goToFiles(element.id)">Files</button>
      </td>
    </ng-container>

    <!-- Details Column -->
    <ng-container matColumnDef="details">
      <th mat-header-cell *matHeaderCellDef mat-sort-header></th>
      <td mat-cell *matCellDef="let element">
        <button type="button" class="btn btn-primary btn-sm" (click)="goToTask(element.id)">Details</button>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedTasksColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedTasksColumns;"></tr>

  </table>

  <div *ngIf="areTasksLoading" style="display: flex; justify-content: center; align-items: center; background: white; margin-top: 20px">
    <mat-progress-spinner
      color="primary"
      mode="indeterminate"
      diameter="50">
    </mat-progress-spinner>
  </div>

  <mat-paginator #userTasksPaginator [pageSizeOptions]="[10, 30, 100]" showFirstLastButtons></mat-paginator>
</div>

<br/>

<h5>List of historical tasks</h5>
<div class="mat-elevation-z8">
  <table mat-table #userHistoricalTasksTable [dataSource]="userHistoricalTasks" matSort matSortActive="id" matSortDisableClear matSortDirection="asc">

    <!-- Id Column -->
    <ng-container matColumnDef="id">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Id </th>
      <td mat-cell *matCellDef="let element"> {{element?.id}} </td>
    </ng-container>

    <!-- Name Column -->
    <ng-container matColumnDef="name">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Name </th>
      <td mat-cell *matCellDef="let element"> {{element?.name}} </td>
    </ng-container>

    <!-- Number of CPUs Column -->
    <ng-container matColumnDef="numberOfCpus">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Number of CPUs </th>
      <td mat-cell *matCellDef="let element"> {{element?.numberOfCpus}} </td>
    </ng-container>

    <!-- Number of GPUs Column -->
    <ng-container matColumnDef="numberOfGpus">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Number of GPUs </th>
      <td mat-cell *matCellDef="let element"> {{element?.numberOfGpus}} </td>
    </ng-container>

    <!-- Ram memory Column -->
    <ng-container matColumnDef="ramMemory">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> RAM memory (GB)</th>
      <td mat-cell *matCellDef="let element"> {{toGb(element?.ramMemory)}} </td>
    </ng-container>

    <!-- Schema id Column -->
    <ng-container matColumnDef="schemaId">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Schema id </th>
      <td mat-cell *matCellDef="let element"> <a [routerLink]="'/schema/' + element?.schemaId">{{element?.schemaId}}</a></td>
    </ng-container>

    <!-- Resource id Column -->
    <ng-container matColumnDef="resourceId">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Resource id </th>
      <td mat-cell *matCellDef="let element"> <a [routerLink]="'/resource/' + element?.resourceId">{{element?.resourceId}}</a> </td>
    </ng-container>

    <!-- Create time id Column -->
    <ng-container matColumnDef="createDateTime">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Creation time </th>
      <td mat-cell *matCellDef="let element"> {{element.createDateTime}} </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedHistoricalTasksColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedHistoricalTasksColumns;"></tr>

  </table>

  <mat-paginator #userHistoricalTasksPaginator [pageSizeOptions]="[10, 30, 100]" showFirstLastButtons></mat-paginator>
</div>

<br/>

<form class="row g-3">
  <div class="col-12" *ngIf="isRemovalAllowed == false">
    <button type="submit" class="btn btn-primary" (click)="allowRemoval()">Delete user</button>
  </div>
  <div class="col-12" *ngIf="isRemovalAllowed == true">
    <button type="submit" class="btn btn-warning" (click)="deleteUser()">Click here to confirm user delete</button>&nbsp;
    <button type="submit" class="btn btn-primary" (click)="reload()">Cancel</button>
  </div>
</form>

<br/>

